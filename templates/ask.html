{% extends "base.html" %}

{% block content %}
<section class="section narrow">
  <h1>Ask the Archive</h1>
  <p class="lead">Type a question and the AI guide will search testimonies and respond with context and recommended videos.</p>
  <div class="search-panel">
    <input id="question-input" type="text" placeholder="e.g., What do the testimonies say about displacement in 2020?" />
    <button class="button primary" id="ask-button">Ask</button>
  </div>

  <div class="ai-response" id="ai-response">
    <p class="response-title">AI Response</p>
    <p id="response-text">Ask a question to see a response.</p>
    <div id="response-videos" class="response-videos"></div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  const videos = {{ videos | tojson }};
  const input = document.getElementById('question-input');
  const responseText = document.getElementById('response-text');
  const responseVideos = document.getElementById('response-videos');

  function respond() {
    const query = input.value.toLowerCase().trim();
    if (!query) {
      responseText.textContent = 'Please enter a question so the archive can respond.';
      responseVideos.innerHTML = '';
      return;
    }

    const matched = videos.filter(video =>
      [video.title, video.summary, video.key_word, video.year, video.speaker]
        .join(' ')
        .toLowerCase()
        .includes(query)
    );

    responseText.textContent = matched.length
      ? `We found ${matched.length} testimonies that connect to your question. Start with the highlighted stories below.`
      : 'No direct matches yet. Try a broader question or explore the newest testimonies.';

    responseVideos.innerHTML = matched.length
      ? matched.map(video => `
          <div class="response-card">
            <img src="${video.thumbnail}" alt="${video.title}" />
            <div>
              <h3>${video.title}</h3>
              <p>${video.summary}</p>
              <span>${video.speaker} â€¢ ${video.year}</span>
            </div>
          </div>
        `).join('')
      : '<p class="empty">No videos matched this query yet. Check back after new uploads.</p>';
  }

  document.getElementById('ask-button').addEventListener('click', respond);
  input.addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
      respond();
    }
  });
</script>
{% endblock %}
